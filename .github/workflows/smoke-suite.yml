name: Smoke Suite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      # 1. Corregimos la versión del checkout (v5 no existe -> v4)
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.12
          cache: 'pip' # Acelera futuras ejecuciones guardando memoria

      # 2. Instalamos los "órganos" del sistema Linux necesarios para Audio/Video
      # ESTRICTO: Versión corregida por Master Prompt
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libportaudio2 libasound2-dev libgl1-mesa-glx xvfb

      # 3. Instalamos las dependencias de Python
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-web.txt

      # 4. Otorgamos voz a los scripts (permiso de ejecución)
      - name: Grant execution permissions
        run: chmod +x scripts/*.sh

      # 5. Ejecutamos los tests en un entorno gráfico virtual (xvfb)
      - name: Run smoke suite
        env:
          SKYSCANNER_SMOKE: 0
          LUCY_HEADLESS_CI: 1
        run: xvfb-run --auto-servernum ./scripts/run_all_smokes.sh
