version: "3.8"

services:
  lucy-swarm:
    build: .
    container_name: lucy-swarm
    network_mode: host
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [ gpu ]
    environment:
      - RAY_ADDRESS=auto
      - NVIDIA_VISIBLE_DEVICES=all
      - LUCY_MAIN_MODEL=qwen2.5:32b
      - LUCY_API_BASE=http://localhost:11434/v1
    volumes:
      - .:/app
      - /tmp/.X11-unix:/tmp/.X11-unix
      - /dev/shm:/dev/shm
    command: python3 lucy_ignition.py

  lucy-ui:
    image: node:22-alpine
    container_name: lucy-ui
    working_dir: /app/src/ui/aleph_ui
    network_mode: host
    volumes:
      - .:/app
    environment:
      - NODE_ENV=development
    command: sh -c "npm install && npm run dev -- --port 5052"
    depends_on:
      - lucy-swarm

  # Host Agent must run on the HOST system to control X11 properly.
  # However, for convenience, we can run it as a service with host IPC.
  lucy-host-agent:
    build: .
    container_name: lucy-host-agent
    network_mode: host
    environment:
      - DISPLAY=${DISPLAY:-:0}
    volumes:
      - .:/app
      - /tmp/.X11-unix:/tmp/.X11-unix
    command: python3 scripts/x11_file_agent.py
